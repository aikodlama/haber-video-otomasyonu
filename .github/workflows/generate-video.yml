name: Generate News Videos

on:
  workflow_dispatch:
    inputs:
      news_id:
        description: 'Haber ID'
        required: true
        type: string
      title:
        description: 'Haber Başlığı'
        required: true
        type: string
      description:
        description: 'Haber Açıklaması'
        required: true
        type: string
      image_url:
        description: 'Haber Görsel URL'
        required: true
        type: string
      news_url:
        description: 'Haber URL'
        required: true
        type: string

jobs:
  generate-video:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ffmpeg and ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

      - name: Download news image
        run: |
          mkdir -p out
          curl -L -o out/news_image.jpg "${{ github.event.inputs.image_url }}" ||             curl -L -o out/news_image.jpg "https://cdnassets.aa.com.tr/assets/images/aalogomin.png"

      - name: Create video frames
        run: |
          mkdir -p frames
          
          # Create title slide
          convert -size 1920x1080 xc:'#1a1a2e'             -gravity center             -fill white             -font Arial             -pointsize 48             -annotate +0+0 "${{ github.event.inputs.title }}"             frames/frame_001.jpg
          
          # Create description slide
          convert -size 1920x1080 xc:'#16213e'             -gravity center             -fill white             -font Arial             -pointsize 32             -annotate +0+0 "${{ github.event.inputs.description }}"             frames/frame_002.jpg
          
          # Copy news image as frame
          cp out/news_image.jpg frames/frame_003.jpg
          
          # Duplicate frames for 5 second duration each at 30fps
          for i in $(seq -w 1 150); do
            frame_num=$(( (i - 1) / 50 + 1 ))
            cp frames/frame_$(printf "%03d" $frame_num).jpg frames/out_$(printf "%04d" $i).jpg
          done

      - name: Generate video with ffmpeg
        run: |
          ffmpeg -framerate 30 -i frames/out_%04d.jpg             -c:v libx264 -pix_fmt yuv420p -crf 23             -movflags +faststart             out/news_video_${{ github.event.inputs.news_id }}.mp4

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: news-video-${{ github.event.inputs.news_id }}
          path: out/news_video_${{ github.event.inputs.news_id }}.mp4
          retention-days: 7

      - name: Save video info
        run: |
          cat > out/video_info_${{ github.event.inputs.news_id }}.json << EOF
          {
            "news_id": "${{ github.event.inputs.news_id }}",
            "title": "${{ github.event.inputs.title }}",
            "news_url": "${{ github.event.inputs.news_url }}",
            "image_url": "${{ github.event.inputs.image_url }}",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "video_file": "news_video_${{ github.event.inputs.news_id }}.mp4"
          }
          EOF

      - name: Upload video info
        uses: actions/upload-artifact@v4
        with:
          name: video-info-${{ github.event.inputs.news_id }}
          path: out/video_info_${{ github.event.inputs.news_id }}.json
          retention-days: 7
