name: Generate News Videos

on:
  workflow_dispatch:
    inputs:
      news_id:
        description: 'Haber ID'
        required: true
        type: string
      title:
        description: 'Haber Başlığı'
        required: true
        type: string
      description:
        description: 'Haber Açıklaması'
        required: true
        type: string
      image_url:
        description: 'Haber Görsel URL'
        required: true
        type: string
      news_url:
        description: 'Haber URL'
        required: true
        type: string

jobs:
  generate-video:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Download news image
        run: |
          mkdir -p out
          curl -L -o out/news_image.jpg "${{ github.event.inputs.image_url }}" || curl -L -o out/news_image.jpg "https://cdnassets.aa.com.tr/assets/images/aalogomin.png"

      - name: Create simple video from image
        run: |
          # Create a 15-second video from the news image with fade effects
          ffmpeg -loop 1 -i out/news_image.jpg -c:v libx264 -t 15 -pix_fmt yuv420p -vf "fade=t=in:st=0:d=1,fade=t=out:st=14:d=1,scale=1920:1080:force_original_aspect_ratio=decrease,pad=1920:1080:(ow-iw)/2:(oh-ih)/2" out/news_video_${{ github.event.inputs.news_id }}.mp4

      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: news-video-${{ github.event.inputs.news_id }}
          path: out/news_video_${{ github.event.inputs.news_id }}.mp4
          retention-days: 30

      - name: Save video info
        run: |
          cat > out/video_info_${{ github.event.inputs.news_id }}.json << 'EOF'
          {
            "news_id": "${{ github.event.inputs.news_id }}",
            "title": "${{ github.event.inputs.title }}",
            "news_url": "${{ github.event.inputs.news_url }}",
            "created_at": "$(date -Iseconds)"
          }
          EOF

      - name: Upload video info
        uses: actions/upload-artifact@v4
        with:
          name: video-info-${{ github.event.inputs.news_id }}
          path: out/video_info_${{ github.event.inputs.news_id }}.json
          retention-days: 30